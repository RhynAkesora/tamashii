# 正式リリース チェックリスト

> このファイルは「魂の共鳴」を正式リリース版として仕上げるための全タスクを管理します。
> 各タスクは優先度順に並べてあり、完了したら `[x]` に変更してください。
> コンテキスト制限があるため、1セッションで全てを対処する必要はありません。
> 少しずつ進めていきましょう。

---

## フェーズ1: クリティカルバグ修正 (HIGH)

### 1.1 タッチ/クリック座標スケーリング修正
- [x] `touchend` ハンドラの座標を canvas 論理ピクセルにスケーリング ✅ v3.728
- [x] `click` ハンドラも同様に修正 ✅ v3.728

### 1.2 `canMove()` の `newY < 0` チェック追加
- [x] `canMove()`: `newY < 0` のセルをスキップ（テトリス方式） ✅ v3.728
- [x] ゴーストピース計算にも同様のガードを追加 ✅ v3.728

### 1.3 `isFullWidth()` ロジック修正
- [x] スパンチェック → 全カラム存在チェック（Uint8Array）に変更 ✅ v3.728

---

## フェーズ2: 中優先度バグ修正 (MEDIUM)

### 2.1 `gameOver()` 再入ガード追加
- [x] `gameOverInProgress` フラグで async 処理中の再入を防止 ✅ v3.729
- [x] `resetGame()` でフラグをリセット ✅ v3.729

### 2.2 `rankPosition` 計算の確認
- [x] 降順リストでの `<=` 検索は標準的なリーダーボード方式 — 問題なし ✅ 確認済

### 2.3 未クリアの `setTimeout` ハンドル
- [x] `gameOverTimers[]` 配列で全 setTimeout を管理 ✅ v3.729
- [x] `resetGame()` で全タイマーをクリア ✅ v3.729
- [x] `playGameOverBGMDelayed()` のタイマーも管理対象に追加 ✅ v3.729

### 2.4 マルチタッチ時の `isTouchHolding` リセット
- [x] 2本指タッチ開始時に `isTouchHolding` と `softDropTimer` をリセット ✅ v3.729

---

## フェーズ3: PWA / オフライン対応

### 3.1 Service Worker キャッシュ漏れ修正
- [x] `logo-white.png` — 既にキャッシュリストに含まれていた ✅ 確認済
- [x] `game-title.png` — 既にキャッシュリストに含まれていた ✅ 確認済

### 3.2 `cache.addAll()` の耐障害性向上（検討）
- [x] 全アセットがリポジトリに含まれており404リスクは極めて低い — 現状維持 ✅ 確認済

### 3.3 manifest.json の強化（任意）
- [ ] `screenshots` フィールドの追加（スクリーンショット画像が必要）
- [ ] `related_applications` の追加（ネイティブアプリ連携用）

---

## フェーズ4: パフォーマンス最適化

### 4.1 `drawBlock3D()` のグラデーション最適化
- [ ] ~L1501: 毎フレーム `createRadialGradient` → 共有グラデーントまたは単色fallback
- **影響**: フレームあたり数百のグラデーション生成（GPU負荷）

### 4.2 `simulateSand()` の Set 再構築最適化（検討）
- [ ] ~L2410: 毎フレームのSet再構築 → インクリメンタル更新を検討
- **影響**: 4000+パーティクル × 毎フレーム × 3回のイテレーション

### 4.3 `findConnectedComponents()` の最適化（検討）
- [ ] ~L2308: 5色×O(n)スキャン×DFS を毎クリアリングフレームで実行
- **影響**: ライン消去チェーン中のCPU負荷

### 4.4 Feverモードのグラデーション最適化
- [ ] ~L4513: 8+グラデーションオブジェクト/フレーム
- **影響**: Fever時の追加GPU負荷

### 4.5 `updateScoreDisplay()` innerHTML → textContent
- [x] HTML構造上 innerHTML が必要（`<span>` / `<br>` タグ使用）。値は全て数値でXSSリスクなし — 現状維持 ✅ 確認済

### 4.6 `resize` ハンドラのデバウンス追加
- [x] 50msデバウンスを追加、リドロー処理をデバウンス内に移動 ✅ v3.730

---

## フェーズ5: コード品質 / デッドコード除去

### 5.1 デッドコード除去
- [x] `pieceType` 変数と二重 `findIndex` を削除 ✅ v3.730
- [x] `overflowDetected` 変数を完全削除（宣言、resetGame、全消去の3箇所） ✅ v3.730
- [x] `NEXT_PIECE_LABEL` 定数を削除（未使用） ✅ v3.730
- [x] `NEXT_PIECE_PADDING` — 1箇所で使用中のため保持 ✅ 確認済

### 5.2 未使用アセット確認
- [ ] `logo.png` — コード未参照、Service Worker未キャッシュ。削除検討

### 5.3 `buildStageBgCache()` のキャンバス再利用
- [ ] ~L1243: 毎回新規canvas生成 → 単一canvasの再利用
- **影響**: Android WebViewでのGPUメモリリーク防止

### 5.4 `welcomeAnimFrame` のクリーンアップ
- [x] `resetGame()` で `cancelAnimationFrame(welcomeAnimFrame)` を追加 ✅ v3.730

---

## フェーズ6: セキュリティ / 審査対策

### 6.1 CSP ポリシー確認
- [x] `unsafe-inline` — 全JSがインラインscriptのため必須 ✅ 確認済
- [x] `unsafe-eval` — Firebase SDK (dynamic import) 依存のため必須 ✅ 確認済
- [x] `connect-src` — Firebase/AdMob ドメインに正しく限定 ✅ 確認済

### 6.2 innerHTML の使用箇所確認
- [x] スコア表示（数値のみ）、コンボ表示（数値のみ）— XSSリスクなし ✅ 確認済
- [x] HTML構造上 `<span>`/`<br>` タグが必要なため innerHTML を維持 ✅ 確認済

### 6.3 プレイヤー名サニタイゼーション
- [x] NGワードフィルタ実装済み（~L829-875）
- [x] 長さ制限（10文字）実装済み
- [x] コントロール文字除去実装済み

### 6.4 スコアバリデーション
- [x] クライアント側バリデーション実装済み ✅ 確認済
- [ ] Firestore Security Rules のサーバー側バリデーション確認（⚠️ ユーザー確認必要）

---

## フェーズ7: プラットフォーム固有

### 7.1 Android AdMob ユニットID
- [ ] ~L534: `'ANDROID_AD_UNIT_ID'` プレースホルダーを実際のIDに置換
  - 現状: iOS用IDにフォールバックしているためads自体は表示される
  - Android版リリース時に必須

### 7.2 Apple Privacy Manifest
- [x] `PrivacyInfo.xcprivacy` 適切に設定済み
- [x] トラッキングドメイン宣言済み
- [x] Required Reason API 宣言済み

---

## フェーズ8: ドキュメント / メタデータ

### 8.1 README.md の充実（任意）
- [ ] アプリ説明、スクリーンショット、技術スタックの追記
- [ ] ビルド手順（Capacitor）の記載

### 8.2 ライセンス情報
- [ ] LICENSE ファイルの追加（必要な場合）

---

## 進捗サマリー

| フェーズ | 項目数 | 完了 | 状態 |
|---------|--------|------|------|
| 1. クリティカルバグ | 3 | 3 | ✅ 完了 |
| 2. 中優先度バグ | 4 | 4 | ✅ 完了 |
| 3. PWA対応 | 3 | 2 | 一部完了 |
| 4. パフォーマンス | 6 | 2 | 一部完了 |
| 5. コード品質 | 4 | 3 | 一部完了 |
| 6. セキュリティ | 4 | 3 | ほぼ完了 |
| 7. プラットフォーム | 2 | 1 | 一部完了 |
| 8. ドキュメント | 2 | 0 | 未着手 |
